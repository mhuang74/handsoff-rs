#!/bin/bash
# PostInstall script for HandsOff
# This script runs after the .app is installed to /Applications

set -e

APP_NAME="HandsOff"
APP_PATH="/Applications/${APP_NAME}.app"
LAUNCH_AGENT_DIR="${HOME}/Library/LaunchAgents"
LAUNCH_AGENT_PLIST="${LAUNCH_AGENT_DIR}/com.handsoff.inputlock.plist"
BUNDLE_ID="com.handsoff.inputlock"

echo "HandsOff PostInstall Script"
echo "============================"

# Verify the app was installed
if [ ! -d "${APP_PATH}" ]; then
    echo "ERROR: ${APP_PATH} not found!"
    exit 1
fi

echo "✓ Application installed at ${APP_PATH}"

# Check if Launch Agent plist already exists
if [ -f "${LAUNCH_AGENT_PLIST}" ]; then
    echo ""
    echo "Launch Agent already configured at:"
    echo "  ${LAUNCH_AGENT_PLIST}"
    echo ""

    # Check if it's already loaded
    if launchctl list | grep -q "${BUNDLE_ID}"; then
        echo "Launch Agent is already loaded and running."
        echo ""
        echo "To restart with new configuration:"
        echo "  launchctl unload ${LAUNCH_AGENT_PLIST}"
        echo "  launchctl load ${LAUNCH_AGENT_PLIST}"
    else
        echo "Loading Launch Agent..."
        launchctl load "${LAUNCH_AGENT_PLIST}"
        echo "✓ Launch Agent loaded successfully"
    fi
else
    echo ""
    echo "=========================================="
    echo "IMPORTANT: Configuration Required"
    echo "=========================================="
    echo ""
    echo "HandsOff requires a secret passphrase to unlock."
    echo ""
    echo "To complete setup, run:"
    echo ""
    echo "  /Applications/${APP_NAME}.app/Contents/MacOS/setup-launch-agent.sh"
    echo ""
    echo "This will prompt you for your passphrase and configure"
    echo "the app to start automatically at login."
    echo ""
fi

echo ""
echo "Installation complete!"
echo ""
echo "For help and documentation:"
echo "  Open the HandsOff menu bar icon and click 'Help'"
echo ""

exit 0