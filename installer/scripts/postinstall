#!/bin/bash
# PostInstall script for HandsOff
# Automatically sets up LaunchAgent (no user interaction needed)

set -e

APP_NAME="HandsOff"
APP_PATH="${HOME}/Applications/${APP_NAME}.app"
LAUNCH_AGENT_DIR="${HOME}/Library/LaunchAgents"
LAUNCH_AGENT_PLIST="${LAUNCH_AGENT_DIR}/com.handsoff.inputlock.plist"
BUNDLE_ID="com.handsoff.inputlock"
PLIST_TEMPLATE="${APP_PATH}/Contents/Resources/com.handsoff.inputlock.plist.template"

echo "HandsOff PostInstall Script"
echo "============================"
echo ""
echo "DEBUG: HOME=${HOME}"
echo "DEBUG: APP_PATH=${APP_PATH}"
echo "DEBUG: PLIST_TEMPLATE=${PLIST_TEMPLATE}"
echo "DEBUG: Checking if app exists..."
ls -la "${APP_PATH}" 2>&1 | head -5
echo "DEBUG: Checking if Resources exists..."
ls -la "${APP_PATH}/Contents/Resources" 2>&1 | head -10
echo ""

# Create LaunchAgents directory if it doesn't exist
mkdir -p "${LAUNCH_AGENT_DIR}"

# Check if plist already exists
if [ -f "${LAUNCH_AGENT_PLIST}" ]; then
    echo "Launch Agent already exists. Updating..."
    # Unload existing agent
    launchctl unload "${LAUNCH_AGENT_PLIST}" 2>/dev/null || true
fi

# Copy template and substitute HOME path
# Try a few times in case of timing issues with atomic file operations
for i in 1 2 3 4 5; do
    if [ -f "${PLIST_TEMPLATE}" ]; then
        sed "s|HOME_PLACEHOLDER|${HOME}|g" "${PLIST_TEMPLATE}" > "${LAUNCH_AGENT_PLIST}"
        chmod 644 "${LAUNCH_AGENT_PLIST}"
        echo "✓ Launch Agent plist created"
        break
    else
        if [ $i -lt 5 ]; then
            echo "Waiting for app files to be available... (attempt $i/5)"
            sleep 1
        else
            echo "⚠️  Warning: Plist template not found at ${PLIST_TEMPLATE}"
            echo "   Launch Agent not configured."
            echo "   You can run this manually later:"
            echo "   ~/Applications/HandsOff.app/Contents/MacOS/setup-launch-agent.sh"
            exit 0
        fi
    fi
done

# Load the launch agent
if launchctl load "${LAUNCH_AGENT_PLIST}" 2>/dev/null; then
    echo "✓ Launch Agent loaded successfully"
else
    echo "⚠️  Could not load Launch Agent (may need to grant permissions first)"
fi

echo ""
echo "=========================================="
echo "NEXT STEPS - Important!"
echo "=========================================="
echo ""
echo "1. Grant Accessibility Permissions:"
echo "   Go to: System Preferences > Security & Privacy"
echo "            > Privacy > Accessibility"
echo "   Click the lock to make changes"
echo "   Click '+' and add: ~/Applications/HandsOff.app"
echo "   Check the box next to HandsOff"
echo ""
echo "2. Configure Your Passphrase:"
echo "   Run this command in Terminal:"
echo ""
echo "   ~/Applications/HandsOff.app/Contents/MacOS/handsoff-tray --setup"
echo ""
echo "   This will prompt you for:"
echo "   - Secret passphrase (typing hidden)"
echo "   - Auto-lock timeout (default: 30s)"
echo "   - Auto-unlock timeout (default: 60s)"
echo ""
echo "3. Restart the App:"
echo "   The tray app should start automatically at login."
echo "   To start it now:"
echo ""
echo "   launchctl start com.handsoff.inputlock"
echo ""
echo "=========================================="
echo "Installation complete!"
echo "=========================================="
echo ""

exit 0